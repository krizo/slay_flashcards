name: CI ‚Äì Backend + Frontend + Smoke test

on:
  push:
    branches:
      - staging
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "staging"
        type: choice
        options:
          - "staging"
          - "production"
      deploy:
        description: "Deploy after build?"
        required: true
        default: "true"
        type: choice
        options:
          - "false"
          - "true"
      recreate_database:
        description: "Recreate database and add demo data?"
        required: true
        default: "true"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  ci:
    runs-on: self-hosted
    env:
      BACKEND_PID_FILE: /tmp/slayflashcards-backend-ci.pid
      FRONTEND_PID_FILE: /tmp/slayflashcards-frontend-ci.pid
      # Environment-specific configurations
      DEPLOY_DIR: ${{ github.event.inputs.environment == 'production' && '/opt/slayflashcards/production' || '/opt/slayflashcards/staging' }}
      BACKEND_PORT: ${{ github.event.inputs.environment == 'production' && '8002' || '8000' }}
      FRONTEND_PORT: ${{ github.event.inputs.environment == 'production' && '3002' || '3000' }}
      SERVICE_SUFFIX: ${{ github.event.inputs.environment == 'production' && '-production' || '-staging' }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Backend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: üì¶ Create virtual environment and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: üóÑÔ∏è Initialize database
        run: |
          source .venv/bin/activate
          python -c "from core.db.database import Base, engine; Base.metadata.create_all(bind=engine); print('Database initialized')"

      - name: üöÄ Start FastAPI backend
        run: |
          source .venv/bin/activate
          nohup uvicorn api.main_api:app --host 0.0.0.0 --port 8001 > /tmp/backend-ci.log 2>&1 &
          echo $! > $BACKEND_PID_FILE
          echo "Backend started with PID $(cat $BACKEND_PID_FILE)"
          sleep 3

      - name: ‚úÖ Verify backend is running
        run: |
          if ! ps -p $(cat $BACKEND_PID_FILE) > /dev/null; then
            echo "Backend failed to start!"
            cat /tmp/backend-ci.log
            exit 1
          fi

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Frontend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üü¶ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: üì¶ Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: üõ† Build frontend
        working-directory: frontend
        run: npm run build

      - name: üöÄ Start frontend preview server
        working-directory: frontend
        run: |
          nohup npm run preview -- --port 3001 > /tmp/frontend-ci.log 2>&1 &
          echo $! > $FRONTEND_PID_FILE
          echo "Frontend started with PID $(cat $FRONTEND_PID_FILE)"
          sleep 5

      - name: ‚úÖ Verify frontend is running
        run: |
          if ! ps -p $(cat $FRONTEND_PID_FILE) > /dev/null; then
            echo "Frontend failed to start!"
            cat /tmp/frontend-ci.log
            exit 1
          fi

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Smoke tests ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üß™ Smoke test backend
        run: |
          echo "Testing backend at http://localhost:8001/docs"
          curl -f http://localhost:8001/docs || (cat /tmp/backend-ci.log && exit 1)

      - name: üß™ Smoke test frontend
        run: |
          echo "Testing frontend at http://localhost:3001"
          curl -f http://localhost:3001 || (cat /tmp/frontend-ci.log && exit 1)

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Cleanup test processes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üßπ Stop test backend and frontend
        if: always()
        run: |
          if [ -f "$BACKEND_PID_FILE" ]; then
            kill $(cat $BACKEND_PID_FILE) 2>/dev/null || true
            rm $BACKEND_PID_FILE
          fi
          if [ -f "$FRONTEND_PID_FILE" ]; then
            kill $(cat $FRONTEND_PID_FILE) 2>/dev/null || true
            rm $FRONTEND_PID_FILE
          fi
          # Kill any remaining uvicorn/vite processes on CI ports
          pkill -f "uvicorn.*:8001" || true
          pkill -f "vite.*3001" || true

      #      - name: Backend Tests
      #        run: |
      #          pytest tests

      #      - name: Frontend Tests
      #        working-directory: frontend
      #        run: |
      #          npm run test

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Conditional Deploy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: üöÄ Deploy to ${{ github.event.inputs.environment }}
        if: ${{ github.event.inputs.deploy == 'true' }}
        run: |
          echo "=== Deploying to ${{ github.event.inputs.environment }} ==="
          echo "Deploy directory: $DEPLOY_DIR"
          echo "Backend port: $BACKEND_PORT"
          echo "Frontend port: $FRONTEND_PORT"
          echo "Service suffix: $SERVICE_SUFFIX"

          # Create deployment directories
          sudo mkdir -p $DEPLOY_DIR/{frontend,backend}

          # Deploy frontend (dist folder for serving)
          echo "üì¶ Deploying frontend..."
          sudo rsync -av --delete frontend/dist/ $DEPLOY_DIR/frontend/dist/

          # Copy package files needed for vite preview
          sudo cp frontend/package.json $DEPLOY_DIR/frontend/
          sudo cp frontend/package-lock.json $DEPLOY_DIR/frontend/ || true
          sudo cp frontend/vite.config.ts $DEPLOY_DIR/frontend/

          # Install frontend dependencies (including vite for preview server)
          echo "üì¶ Installing frontend dependencies..."
          cd $DEPLOY_DIR/frontend
          sudo npm ci

          # Return to repository directory for backend deployment
          cd $GITHUB_WORKSPACE

          # Deploy backend (api + core + requirements + scripts)
          echo "üì¶ Deploying backend..."
          sudo rsync -av --delete api/ $DEPLOY_DIR/backend/api/
          sudo rsync -av --delete core/ $DEPLOY_DIR/backend/core/
          sudo rsync -av --delete scripts/ $DEPLOY_DIR/backend/scripts/
          sudo rsync -av --delete data/ $DEPLOY_DIR/backend/data/ || true
          sudo rsync -av requirements.txt $DEPLOY_DIR/backend/

          # Setup Python virtual environment
          echo "üêç Setting up Python virtual environment..."
          sudo python3 -m venv $DEPLOY_DIR/backend/.venv
          sudo $DEPLOY_DIR/backend/.venv/bin/pip install --upgrade pip
          sudo $DEPLOY_DIR/backend/.venv/bin/pip install -r $DEPLOY_DIR/backend/requirements.txt

          # Set proper permissions
          echo "üîê Setting permissions..."
          sudo chown -R $USER:$USER $DEPLOY_DIR/
          sudo chmod -R 755 $DEPLOY_DIR/

          # Initialize/reset database based on input
          echo "üóÑÔ∏è Database setup..."
          cd $DEPLOY_DIR/backend
          if [ "${{ github.event.inputs.recreate_database }}" == "true" ]; then
            echo "Recreating database with demo data..."
            sudo -u $USER .venv/bin/python scripts/init_database.py --reset --demo
          else
            echo "Initializing database (keeping existing data)..."
            sudo -u $USER .venv/bin/python scripts/init_database.py
          fi

          # Return to repository directory for deployment files
          cd $GITHUB_WORKSPACE

          # Install/update systemd service files
          echo "‚öôÔ∏è Installing systemd service files..."
          sudo cp deployment/slayflashcards-backend$SERVICE_SUFFIX.service /etc/systemd/system/
          sudo cp deployment/slayflashcards-frontend$SERVICE_SUFFIX.service /etc/systemd/system/
          sudo systemctl daemon-reload

          # Restart services
          echo "üîÑ Restarting services..."
          sudo systemctl restart slayflashcards-backend$SERVICE_SUFFIX
          sudo systemctl restart slayflashcards-frontend$SERVICE_SUFFIX

          # Verify services are running
          echo "‚úÖ Verifying deployment..."
          sudo systemctl status slayflashcards-backend$SERVICE_SUFFIX --no-pager || true
          sudo systemctl status slayflashcards-frontend$SERVICE_SUFFIX --no-pager || true

          echo ""
          echo "=== Deployment complete ==="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Backend URL: http://localhost:$BACKEND_PORT"
          echo "Frontend URL: http://localhost:$FRONTEND_PORT"